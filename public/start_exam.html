<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkPlus - Start Exam</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1437 25%, #2d1b4e 50%, #1a1437 75%, #0a0e27 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
            pointer-events: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #a78bfa 0%, transparent 70%);
            top: -250px;
            left: -250px;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #ec4899 0%, transparent 70%);
            top: 50%;
            right: -200px;
            animation-delay: 5s;
        }

        .orb3 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
            bottom: -150px;
            left: 30%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -50px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-image:
                linear-gradient(rgba(167, 139, 250, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(167, 139, 250, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        .page-wrapper {
            position: relative;
            z-index: 2;
            padding: 3rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .exam-setup-card {
            max-width: 700px;
            width: 95%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(167, 139, 250, 0.15);
            border: 1px solid rgba(167, 139, 250, 0.25);
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(167, 139, 250, 0.2);
        }

        .card-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .card-header p {
            font-size: 1.1rem;
            color: #94a3b8;
        }

        .exam-badge {
            display: inline-block;
            padding: 0.4rem 1.25rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.75rem;
            border: 1px solid;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .easy {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-color: rgba(16, 185, 129, 0.5);
        }

        .medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border-color: rgba(245, 158, 11, 0.5);
        }

        .hard {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.5);
        }

        .mixed {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .detail-item p {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .detail-item strong {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }

        .exam-rules {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(167, 139, 250, 0.2);
        }

        .exam-rules h2 {
            font-size: 1.5rem;
            color: #f1f5f9;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .exam-rules ul {
            list-style-type: '⚡';
            padding-left: 1.5rem;
            color: #cbd5e1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .exam-rules ul li {
            font-size: 1rem;
            line-height: 1.5;
            padding-left: 0.5rem;
        }

        .start-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .agreement {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            color: #cbd5e1;
            cursor: pointer;
        }

        .agreement input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #a78bfa;
            cursor: pointer;
            flex-shrink: 0;
        }

        .agreement label {
            cursor: pointer;
            user-select: none;
        }

        .btn-start {
            width: 100%;
            max-width: 300px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(167, 139, 250, 0.4);
        }

        .btn-start:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(167, 139, 250, 0.6);
        }

        .btn-start:disabled {
            background: #475569 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
            box-shadow: none !important;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(167, 139, 250, 0.3);
            border-top-color: #a78bfa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading-spinner.active {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: #fca5a5;
            text-align: center;
            margin-top: 1rem;
            display: none;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .error-message.active {
            display: block;
        }

        .loading-status {
            color: #a78bfa;
            text-align: center;
            font-size: 0.95rem;
            margin-top: 0.5rem;
            min-height: 20px;
        }

        @media (max-width: 768px) {
            .exam-setup-card {
                padding: 1.5rem;
            }

            .card-header h1 {
                font-size: 2rem;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .btn-start {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="gradient-bg"></div>
    <div class="orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
        <div class="orb orb3"></div>
    </div>
    <div class="grid-overlay"></div>
    <div class="page-wrapper">
        <div class="exam-setup-card">

            <div class="card-header">
                <p id="currentDateTime">Loading...</p>
                <h1 id="examTitle">Loading Exam...</h1>
                <span id="difficultyBadge" class="exam-badge medium">Medium</span>
            </div>

            <div class="details-grid">
                <div class="detail-item">
                    <p>Duration</p>
                    <strong id="duration">--</strong>
                    <p style="margin-top: 0; color: #cbd5e1; font-weight: 500; font-size: 0.9rem;">Minutes</p>
                </div>
                <div class="detail-item">
                    <p>Total Questions</p>
                    <strong id="totalQuestions">--</strong>
                    <p style="margin-top: 0; color: #cbd5e1; font-weight: 500; font-size: 0.9rem;">Questions</p>
                </div>
                <div class="detail-item">
                    <p>Total Marks</p>
                    <strong id="totalMarks">--</strong>
                    <p style="margin-top: 0; color: #cbd5e1; font-weight: 500; font-size: 0.9rem;">Marks</p>
                </div>
                <div class="detail-item">
                    <p>Passing Score</p>
                    <strong id="passingScore">--</strong>
                    <p style="margin-top: 0; color: #cbd5e1; font-weight: 500; font-size: 0.9rem;">Minimum</p>
                </div>
            </div>

            <div class="exam-rules">
                <h2>Exam Instructions</h2>
                <ul id="examInstructions">
                    <li>Loading instructions...</li>
                </ul>
            </div>

            <div class="start-action">
                <label class="agreement" for="agreementCheckbox">
                    <input type="checkbox" id="agreementCheckbox">
                    <span>I have read and understood all the instructions above.</span>
                </label>
                <button class="btn-start" id="startExamButton" disabled>Start Exam</button>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <p class="loading-status" id="loadingStatus"></p>
                <p class="error-message" id="errorMessage"></p>
            </div>

        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://mqosqiucfkrmscfkacto.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xb3NxaXVjZmtybXNjZmthY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NTQ4MDMsImV4cCI6MjA3NTQzMDgwM30.b6PYbitm8uUcQPd_Yc1qGbV6WGfZSQlDI_RxrHjzZC0';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storage: window.sessionStorage,
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const checkbox = document.getElementById('agreementCheckbox');
            const startButton = document.getElementById('startExamButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            const loadingStatus = document.getElementById('loadingStatus');

            const scheduledExamId = getUrlParameter('scheduled_exam_id');
            if (!scheduledExamId) {
                errorMessage.textContent = 'No exam ID provided.';
                errorMessage.classList.add('active');
                return;
            }

            loadingStatus.textContent = 'Checking authentication...';
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError || !session) {
                errorMessage.textContent = 'Please log in first. Redirecting to login page...';
                errorMessage.classList.add('active');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            const user = session.user;
            console.log('User authenticated:', user.email);

            try {
                loadingStatus.textContent = 'Loading exam details...';

                const { data: exam, error: examError } = await supabase
                    .from('scheduled_exams')
                    .select('*')
                    .eq('scheduled_exam_id', scheduledExamId)
                    .single();

                if (examError) throw examError;

                loadingStatus.textContent = '';

                document.getElementById('examTitle').textContent = exam.exam_name;
                document.getElementById('duration').textContent = exam.duration;
                document.getElementById('totalQuestions').textContent = exam.total_questions;
                document.getElementById('totalMarks').textContent = exam.total_questions;
                document.getElementById('passingScore').textContent = exam.passing_score + '%';

                const badge = document.getElementById('difficultyBadge');
                const difficulty = exam.difficulty || 'mixed';
                badge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
                badge.className = 'exam-badge ' + difficulty.toLowerCase();

                const instructionsList = document.getElementById('examInstructions');
                instructionsList.innerHTML = `
                    <li>The exam duration is <strong>${exam.duration} minutes</strong>.</li>
                    <li>There are <strong>${exam.total_questions} multiple-choice questions</strong>.</li>
                    <li>You must score at least <strong>${exam.passing_score}%</strong> to pass.</li>
                    <li>Navigate freely between questions using the navigation panel.</li>
                    <li>Switching tabs may trigger warnings and auto-submit your exam.</li>
                    <li>Ensure stable internet connection throughout.</li>
                `;

                const now = new Date();
                document.getElementById('currentDateTime').textContent = now.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

            } catch (err) {
                console.error(err);
                errorMessage.textContent = 'Error loading exam: ' + err.message;
                errorMessage.classList.add('active');
                loadingStatus.textContent = '';
                return;
            }

            checkbox.addEventListener('change', () => startButton.disabled = !checkbox.checked);

            startButton.addEventListener('click', async () => {
                if (!checkbox.checked) return;

                startButton.disabled = true;
                startButton.textContent = 'Starting Exam...';
                loadingSpinner.classList.add('active');
                errorMessage.classList.remove('active');
                loadingStatus.textContent = 'Preparing your exam...';

                try {
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    if (sessionError || !session) {
                        throw new Error('Session expired. Please log in again.');
                    }
                    const user = session.user;

                    loadingStatus.textContent = 'Loading your profile...';
                    const { data: profileDataArray, error: profileError } = await supabase
                        .from('profiles')
                        .select('student_id, email, full_name')
                        .eq('id', user.id);

                    console.log('Profile data:', profileDataArray);

                    if (profileError) {
                        console.error('Profile fetch error:', profileError);
                        throw new Error('Failed to load your profile: ' + profileError.message);
                    }

                    let profileData = profileDataArray;
                    if (!profileDataArray || profileDataArray.length === 0) {
                        console.log('No profile found. Creating one...');
                        const { data: newProfile, error: createError } = await supabase
                            .from('profiles')
                            .insert([{
                                id: user.id,
                                email: user.email,
                                full_name: user.user_metadata?.full_name || user.email.split('@')[0],
                                created_at: new Date().toISOString()
                            }])
                            .select();

                        if (createError) {
                            throw new Error('Failed to create profile: ' + createError.message);
                        }
                        
                        profileData = newProfile;
                    }

                    const profile = profileData[0];
                    let studentId = profile?.student_id;

                    if (!studentId) {
                        console.warn('No student_id found in profile. Generating one...');
                        studentId = 'STU_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();

                        const { error: updateError } = await supabase
                            .from('profiles')
                            .update({ student_id: studentId })
                            .eq('id', user.id);

                        if (updateError) {
                            console.error('Failed to update student_id:', updateError);
                        } else {
                            console.log('✅ Generated and saved student_id:', studentId);
                        }
                    }

                    console.log('Using student_id:', studentId);

                    loadingStatus.textContent = 'Fetching exam configuration...';
                    const { data: scheduledExam, error: scheduledError } = await supabase
                        .from('scheduled_exams')
                        .select('*')
                        .eq('scheduled_exam_id', scheduledExamId)
                        .single();

                    if (scheduledError) {
                        throw new Error('Failed to fetch exam configuration: ' + scheduledError.message);
                    }

                    const requiredQuestions = scheduledExam.total_questions || 30;
                    console.log('Required questions:', requiredQuestions);

                    loadingStatus.textContent = 'Fetching questions from question bank...';

                    const { data: allAvailableQuestions, error: questionsError } = await supabase
                        .from('questions_bank')
                        .select('*');

                    console.log('Supabase response:', {
                        data: allAvailableQuestions,
                        error: questionsError
                    });

                    if (questionsError) {
                        console.error('Question fetch error details:', questionsError);
                        throw new Error(`Failed to fetch questions: ${questionsError.message}. Code: ${questionsError.code}`);
                    }

                    if (!allAvailableQuestions || allAvailableQuestions.length === 0) {
                        throw new Error('No questions available in question bank. Please contact administrator.');
                    }

                    console.log(`✅ Successfully fetched ${allAvailableQuestions.length} questions from database`);

                    const categorizedQuestions = {
                        'Very Easy': [],
                        'Easy': [],
                        'Moderate': [],
                        'Difficult': []
                    };

                    allAvailableQuestions.forEach(q => {
                        const difficulty = (q.difficulty_level || 'Moderate').toLowerCase();
                        if (difficulty.includes('very easy')) {
                            categorizedQuestions['Very Easy'].push(q);
                        } else if (difficulty.includes('easy')) {
                            categorizedQuestions['Easy'].push(q);
                        } else if (difficulty.includes('moderate') || difficulty.includes('medium')) {
                            categorizedQuestions['Moderate'].push(q);
                        } else if (difficulty.includes('difficult') || difficulty.includes('hard')) {
                            categorizedQuestions['Difficult'].push(q);
                        } else {
                            categorizedQuestions['Moderate'].push(q);
                        }
                    });

                    console.log('Questions by difficulty:', {
                        'Very Easy': categorizedQuestions['Very Easy'].length,
                        'Easy': categorizedQuestions['Easy'].length,
                        'Moderate': categorizedQuestions['Moderate'].length,
                        'Difficult': categorizedQuestions['Difficult'].length
                    });

                    loadingStatus.textContent = 'Selecting balanced question set...';

                    const selectedQuestions = [];
                    const usedQuestionIds = new Set();

                    const quotas = {
                        'Very Easy': Math.round(requiredQuestions * 0.20),
                        'Easy': Math.round(requiredQuestions * 0.20),
                        'Moderate': Math.round(requiredQuestions * 0.30),
                        'Difficult': Math.round(requiredQuestions * 0.30)
                    };

                    const totalQuoted = Object.values(quotas).reduce((a, b) => a + b, 0);
                    if (totalQuoted !== requiredQuestions) {
                        quotas['Moderate'] += (requiredQuestions - totalQuoted);
                    }

                    console.log('Question distribution quotas:', quotas);

                    const difficultyOrder = ['Very Easy', 'Easy', 'Moderate', 'Difficult'];
                    for (const difficulty of difficultyOrder) {
                        const questionsInDifficulty = categorizedQuestions[difficulty];
                        const needed = quotas[difficulty];

                        if (questionsInDifficulty.length === 0) continue;

                        const shuffled = questionsInDifficulty.sort(() => Math.random() - 0.5);

                        let selected = 0;
                        for (const question of shuffled) {
                            if (selected >= needed) break;
                            if (!usedQuestionIds.has(question.question_id)) {
                                selectedQuestions.push(question);
                                usedQuestionIds.add(question.question_id);
                                selected++;
                            }
                        }

                        console.log(`Selected ${selected}/${needed} ${difficulty} questions`);
                    }

                    if (selectedQuestions.length < requiredQuestions) {
                        const remaining = requiredQuestions - selectedQuestions.length;
                        const allUnused = allAvailableQuestions.filter(q => !usedQuestionIds.has(q.question_id));
                        const shuffled = allUnused.sort(() => Math.random() - 0.5);

                        for (let i = 0; i < Math.min(remaining, shuffled.length); i++) {
                            selectedQuestions.push(shuffled[i]);
                            usedQuestionIds.add(shuffled[i].question_id);
                        }
                    }

                    console.log(`✅ Final selection: ${selectedQuestions.length} unique questions`);

                    loadingStatus.textContent = 'Formatting questions...';

                    const formattedQuestions = selectedQuestions.map((q, index) => {
                        let optionsArray = [];

                        if (q.options) {
                            if (typeof q.options === 'string') {
                                try {
                                    const parsed = JSON.parse(q.options);
                                    if (typeof parsed === 'object' && !Array.isArray(parsed)) {
                                        optionsArray = Object.values(parsed).filter(opt => opt && String(opt).trim().length > 0);
                                    } else if (Array.isArray(parsed)) {
                                        optionsArray = parsed.filter(opt => opt && String(opt).trim().length > 0);
                                    }
                                } catch (e) {
                                    if (q.options.includes('|')) {
                                        optionsArray = q.options.split('|').map(o => String(o).trim()).filter(o => o.length > 0);
                                    } else if (q.options.includes(',')) {
                                        optionsArray = q.options.split(',').map(o => String(o).trim()).filter(o => o.length > 0);
                                    } else if (q.options.trim().length > 0) {
                                        optionsArray = [String(q.options).trim()];
                                    }
                                }
                            } else if (Array.isArray(q.options)) {
                                optionsArray = q.options.filter(o => o && String(o).trim().length > 0).map(o => String(o).trim());
                            }
                        }

                        if (optionsArray.length < 2) {
                            console.warn(`Question ${q.question_id} has insufficient options. Using defaults.`);
                            optionsArray = ['Option A', 'Option B', 'Option C', 'Option D'];
                        }

                        while (optionsArray.length < 4) {
                            optionsArray.push(`Option ${String.fromCharCode(65 + optionsArray.length)}`);
                        }

                        return {
                            question_id: q.question_id || `Q${index + 1}`,
                            question_text: q.question_text || 'Question text not available',
                            question_type: q.question_type || 'MCQ',
                            data_paragraph: q.data_paragraph || null,
                            options: optionsArray.slice(0, 4),
                            correct_answer: q.correct_answer || 'A',
                            topic: q.chapter || q.block || 'General',
                            difficulty: q.difficulty_level || 'Moderate'
                        };
                    });

                    console.log(`✅ Formatted ${formattedQuestions.length} questions for exam`);
                    console.log('Sample question:', formattedQuestions[0]);
                    console.log('Difficulty distribution:', formattedQuestions.reduce((acc, q) => {
                        acc[q.difficulty] = (acc[q.difficulty] || 0) + 1;
                        return acc;
                    }, {}));

                    loadingStatus.textContent = 'Creating your exam session...';
                    const examId = 'EXAM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const { error: insertError } = await supabase.from('exams').insert([{
                        exam_id: examId,
                        scheduled_exam_id: scheduledExamId,
                        student_id: studentId,
                        user_id: user.id,
                        questions: formattedQuestions,
                        status: 'in_progress',
                        total_questions: formattedQuestions.length,
                        started_at: new Date().toISOString()
                    }]);

                    if (insertError) throw insertError;

                    console.log('✅ Exam session created with ID:', examId);

                    loadingStatus.textContent = 'Redirecting to exam...';
                    setTimeout(() => {
                        window.location.href = `exam.html?exam_id=${examId}`;
                    }, 500);

                } catch (err) {
                    console.error(err);
                    errorMessage.textContent = 'Error: ' + err.message;
                    errorMessage.classList.add('active');
                    startButton.disabled = false;
                    startButton.textContent = 'Start Exam';
                    loadingStatus.textContent = '';
                } finally {
                    loadingSpinner.classList.remove('active');
                }
            });
        });
    </script>
</body>

</html>