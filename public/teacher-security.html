<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkPlus - Security & Privacy</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- BASE THEME STYLES (Matching Dashboard/Profile) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1437 25%, #2d1b4e 50%, #1a1437 75%, #0a0e27 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* --- ORBS AND GRID OVERLAY (Matching Dashboard/Profile) --- */
        .orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
            pointer-events: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #a78bfa 0%, transparent 70%);
            top: -200px;
            left: -200px;
        }

        .orb2 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, #ec4899 0%, transparent 70%);
            bottom: -150px;
            right: -150px;
            animation-delay: 7s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(50px, -50px) scale(1.1);
            }
            66% {
                transform: translate(-30px, 30px) scale(0.9);
            }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-image: 
                linear-gradient(rgba(167, 139, 250, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(167, 139, 250, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
        
        /* Main Content Styling */
        .main-content {
            position: relative;
            z-index: 2; 
            padding: 2rem;
            max-width: 800px;
            margin: 2rem auto;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-content h1 {
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
            font-weight: 800;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 2rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .info-card {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 30px 90px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(167, 139, 250, 0.15);
            border: 1px solid rgba(167, 139, 250, 0.25);
            margin-bottom: 30px;
        }

        .info-card h2 {
            border-bottom: 2px solid rgba(167, 139, 250, 0.2);
            padding-bottom: 15px;
            margin-bottom: 25px;
            color: #f1f5f9;
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Security List Items */
        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(167, 139, 250, 0.1);
        }
        
        .security-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .security-item div {
            flex-grow: 1;
        }

        .security-item h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #e2e8f0;
        }

        .security-item p {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        /* --- BUTTON STYLES (Themed) --- */
        .action-button, .danger-button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .action-button {
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(167, 139, 250, 0.6);
        }

        /* Toggle Switch Styling - Themed */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #a78bfa;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #a78bfa;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* --- MODAL STYLING (Glassmorphic) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            margin: 10% auto; 
            padding: 30px;
            border: 1px solid rgba(167, 139, 250, 0.25);
            width: 90%;
            max-width: 500px; 
            border-radius: 20px;
            box-shadow: 0 5px 40px rgba(0, 0, 0, 0.8);
            color: #e2e8f0;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(167, 139, 250, 0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #a78bfa; 
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-btn {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #94a3b8;
        }

        .form-group input[type="password"],
        .form-group input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 10px;
            background-color: #1e293b;
            color: #e2e8f0;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus {
            border-color: #a78bfa;
            outline: none;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.4);
            background-color: #0f172a;
        }

        .modal-footer {
            padding-top: 20px;
            text-align: right;
            border-top: 1px solid rgba(167, 139, 250, 0.2);
            margin-top: 20px;
        }

        .save-button, .cancel-button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-left: 10px;
        }

        /* Primary Button (Save) */
        .save-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .save-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            transform: translateY(-1px);
        }
        
        /* Secondary Button (Cancel) */
        .cancel-button {
            background-color: #475569;
            color: white;
            box-shadow: 0 4px 10px rgba(71, 85, 105, 0.3);
            margin-left: 0;
        }
        .cancel-button:hover {
            background-color: #64748b;
            transform: translateY(-1px);
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 1rem;
            }
            .modal-content {
                margin: 5% auto;
            }
            .modal-footer {
                text-align: center;
            }
            .save-button, .cancel-button {
                width: 100%;
                margin: 5px 0 0 0;
            }
            .security-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .toggle-switch, .action-button {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
    </div>
    <div class="grid-overlay"></div>

    <div class="main-content">
        <h1>Security & Privacy</h1>
        <p class="subtitle">Manage your account security features and privacy settings.</p>
        
        <div class="info-card">
            <h2>Account Security</h2>
            
            <div class="security-item">
                <div>
                    <h3>Change Password</h3>
                    <p>Update your password to keep your account secure.</p>
                </div>
                <button id="openChangePasswordModalBtn" class="action-button">Change Password</button>
            </div>

            <div class="security-item">
                <div>
                    <h3>Change Email Address</h3>
                    <p>Update the email address associated with your account.</p>
                </div>
                <button id="openChangeEmailModalBtn" class="action-button">Change Email</button>
            </div>
        </div>

        <div class="info-card">
            <h2>Privacy Settings</h2>
            
            <div class="security-item" style="border-bottom: none;">
                <div>
                    <h3>Data Usage Consent</h3>
                    <p>Allow ThinkPlus to use anonymized data to improve its services.</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleDataConsent" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Password</h2>
                <span class="close-btn change-pass-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancelChangePasswordBtn" class="cancel-button">Cancel</button>
                <button id="saveNewPasswordBtn" class="save-button">Save New Password</button>
            </div>
        </div>
    </div>

    <div id="changeEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Email</h2>
                <span class="close-btn change-email-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changeEmailForm">
                    <div class="form-group">
                        <label for="newEmail">New Email Address</label>
                        <input type="email" id="newEmail" placeholder="your.new@email.com" required>
                    </div>
                    <p style="color: #94a3b8; font-size: 0.9rem; margin-top: -10px;">A confirmation link will be sent to the new email address. After requesting, you will be immediately logged out. You must click the link in the new email to activate the change and sign back in.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancelChangeEmailBtn" class="cancel-button">Cancel</button>
                <button id="saveNewEmailBtn" class="save-button">Send Confirmation</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://mqosqiucfkrmscfkacto.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xb3NxaXVjZmtybXNjZmthY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NTQ4MDMsImV4cCI6MjA3NTQzMDgwM30.b6PYbitm8uUcQPd_Yc1qGbV6WGfZSQlDI_RxrHjzZC0';
        const TEACHER_EMAIL = 'shloksarawade0@gmail.com';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storage: window.sessionStorage,
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // --- NAVBAR LOGIC ---
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return parts[0].substring(0, 2).toUpperCase();
        }

        async function initNavbar(activePage = 'profile') {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return null;
            }

            if (session.user.email.toLowerCase() !== TEACHER_EMAIL.toLowerCase()) {
                window.location.href = 'dashboard.html';
                return null;
            }

            const user = session.user;
            
            const { data: profile } = await supabase
                .from('profiles')
                .select('full_name, avatar_url')
                .eq('id', user.id)
                .single();

            const fullName = profile?.full_name || user.user_metadata?.full_name || user.email.split('@')[0];
            const avatarUrl = profile?.avatar_url;
            
            const initials = getInitials(fullName);

            const navbarHTML = `
                <nav class="navbar">
                    <div class="navbar-brand">
                        <div class="navbar-logo">T+</div>
                        <div class="navbar-text">
                            <h1 class="navbar-title">ThinkPlus</h1>
                            <p class="navbar-subtitle">Teacher Portal</p>
                        </div>
                    </div>
                    <div class="navbar-menu">
                        <a href="teacher-dashboard.html" class="${activePage === 'dashboard' ? 'active' : ''}">Dashboard</a>
                        <a href="teacher-students.html" class="${activePage === 'students' ? 'active' : ''}">Students</a>
                        <a href="teacher-insights.html" class="${activePage === 'insights' ? 'active' : ''}">Insights</a>
                        <a href="teacher-profile.html" class="${activePage === 'profile' ? 'active' : ''}">Profile</a>
                    </div>
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-avatar" id="navUserAvatar">
                                ${avatarUrl ? 
                                    `<img src="${avatarUrl}" alt="${fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                                    initials
                                }
                            </div>
                            <span class="user-name">${fullName}</span>
                        </div>
                        <button class="btn-logout" id="navLogoutBtn">Logout</button>
                    </div>
                </nav>
            `;

            if (!document.getElementById('navbar-styles')) {
                const style = document.createElement('style');
                style.id = 'navbar-styles';
                style.textContent = `
                    .navbar {
                        position: sticky;
                        top: 0;
                        z-index: 100;
                        background: rgba(15, 23, 42, 0.5);
                        backdrop-filter: blur(20px) saturate(180%);
                        padding: 1rem 2rem;
                        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 1px solid rgba(167, 139, 250, 0.25);
                        width: 100%;
                    }
                    .navbar-brand {
                        display: flex;
                        align-items: center;
                        gap: 0.875rem;
                    }
                    .navbar-logo {
                        width: 48px;
                        height: 48px;
                        background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 900;
                        font-size: 1.4rem;
                        box-shadow: 0 8px 25px rgba(167, 139, 250, 0.5);
                        flex-shrink: 0;
                        position: relative;
                    }
                    .navbar-logo::after {
                        content: '';
                        position: absolute;
                        inset: -2px;
                        border-radius: 12px;
                        background: linear-gradient(135deg, #a78bfa, #ec4899);
                        opacity: 0.3;
                        filter: blur(10px);
                        animation: navPulse 3s ease-in-out infinite;
                        z-index: -1;
                    }
                    @keyframes navPulse {
                        0%, 100% { opacity: 0.3; transform: scale(1); }
                        50% { opacity: 0.6; transform: scale(1.05); }
                    }
                    .navbar-text {
                        display: flex;
                        flex-direction: column;
                        gap: 0.125rem;
                    }
                    .navbar-title {
                        font-size: 1.5rem;
                        background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #f59e0b 100%);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        font-weight: 800;
                        letter-spacing: -0.5px;
                        line-height: 1;
                        margin: 0;
                    }
                    .navbar-subtitle {
                        font-size: 0.75rem;
                        color: #94a3b8;
                        font-weight: 500;
                        letter-spacing: 0.025em;
                        margin: 0;
                    }
                    .navbar-menu {
                        display: flex;
                        gap: 2rem;
                        align-items: center;
                    }
                    .navbar-menu a {
                        text-decoration: none;
                        color: #cbd5e1;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        position: relative;
                        padding: 0.5rem 0;
                    }
                    .navbar-menu a:hover {
                        color: #a78bfa;
                    }
                    .navbar-menu a.active {
                        color: #a78bfa;
                    }
                    .navbar-menu a.active::after {
                        content: '';
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: 100%;
                        height: 2px;
                        background: linear-gradient(90deg, #a78bfa, #ec4899);
                        border-radius: 2px;
                    }
                    .user-menu {
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }
                    .user-info {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        padding: 0.5rem 1rem;
                        background: rgba(30, 41, 59, 0.5);
                        border-radius: 50px;
                        border: 1px solid rgba(167, 139, 250, 0.2);
                        backdrop-filter: blur(10px);
                    }
                    .user-avatar {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        font-size: 0.95rem;
                        box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
                        flex-shrink: 0;
                    }
                    .user-name {
                        color: #e2e8f0;
                        font-size: 0.95rem;
                        font-weight: 600;
                        white-space: nowrap;
                    }
                    .btn-logout {
                        padding: 0.75rem 1.5rem;
                        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
                    }
                    .btn-logout:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
                    }
                    @media (max-width: 968px) {
                        .navbar {
                            flex-wrap: wrap;
                            gap: 1rem;
                            padding: 1rem 1.5rem;
                        }
                        .navbar-menu {
                            order: 3;
                            width: 100%;
                            justify-content: center;
                            gap: 1.5rem;
                        }
                    }
                    @media (max-width: 640px) {
                        .navbar-logo {
                            width: 40px;
                            height: 40px;
                            font-size: 1.2rem;
                        }
                        .navbar-title {
                            font-size: 1.25rem;
                        }
                        .navbar-subtitle {
                            font-size: 0.7rem;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            const existingNav = document.querySelector('.navbar');
            if (existingNav) {
                existingNav.outerHTML = navbarHTML;
            } else {
                document.body.insertAdjacentHTML('afterbegin', navbarHTML);
            }

            document.getElementById('navLogoutBtn').addEventListener('click', async () => {
                try {
                    await supabase.auth.signOut();
                    window.location.href = 'index.html';
                } catch (err) {
                    console.error('Logout error:', err);
                    alert('Failed to logout. Please try again.');
                }
            });

            return { user, profile, fullName };
        }
        // --- END NAVBAR LOGIC ---
        
        // --- MODAL 1: Change Password Logic ---
        const changePasswordModal = document.getElementById("changePasswordModal");
        const openChangePassBtn = document.getElementById("openChangePasswordModalBtn");
        const closeChangePassBtn = document.querySelector(".change-pass-close");
        const cancelChangePassBtn = document.getElementById("cancelChangePasswordBtn");
        const saveNewPassBtn = document.getElementById("saveNewPasswordBtn");

        function openChangePasswordModal() { changePasswordModal.style.display = "block"; }
        function closeChangePasswordModal() { changePasswordModal.style.display = "none"; }

        if(openChangePassBtn) openChangePassBtn.addEventListener('click', openChangePasswordModal);
        if(closeChangePassBtn) closeChangePassBtn.addEventListener('click', closeChangePasswordModal);
        if(cancelChangePassBtn) cancelChangePassBtn.addEventListener('click', closeChangePasswordModal);

        if (saveNewPassBtn) {
            saveNewPassBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const newPass = document.getElementById('newPassword').value;
                const confirmPass = document.getElementById('confirmNewPassword').value;

                if (!newPass || !confirmPass) {
                    alert("New password fields are required.");
                    return;
                }

                if (newPass !== confirmPass) {
                    alert("New password and confirmation do not match!");
                    return;
                }

                if (newPass.length < 6) {
                    alert("New password must be at least 6 characters long.");
                    return;
                }

                try {
                    const { error } = await supabase.auth.updateUser({ password: newPass });

                    if (error) throw error;
                    
                    alert('Password changed successfully! You will be logged out and asked to sign in with your new password.');
                    await supabase.auth.signOut();
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error('Error changing password:', error.message);
                    alert('Failed to change password. Please ensure your current session is still valid (try refreshing/logging in again).');
                } finally {
                    document.getElementById('changePasswordForm').reset();
                    closeChangePasswordModal();
                }
            });
        }


        // --- MODAL 2: Change Email Logic ---
        const changeEmailModal = document.getElementById("changeEmailModal");
        const openChangeEmailBtn = document.getElementById("openChangeEmailModalBtn");
        const closeChangeEmailBtn = document.querySelector(".change-email-close");
        const cancelChangeEmailBtn = document.getElementById("cancelChangeEmailBtn");
        const saveNewEmailBtn = document.getElementById("saveNewEmailBtn");

        function openChangeEmailModal() { changeEmailModal.style.display = "block"; }
        function closeChangeEmailModal() { changeEmailModal.style.display = "none"; }

        if(openChangeEmailBtn) openChangeEmailBtn.addEventListener('click', openChangeEmailModal);
        if(closeChangeEmailBtn) closeChangeEmailBtn.addEventListener('click', closeChangeEmailModal);
        if(cancelChangeEmailBtn) cancelChangeEmailBtn.addEventListener('click', closeChangeEmailModal);

        if (saveNewEmailBtn) {
            saveNewEmailBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const newEmail = document.getElementById('newEmail').value;
                const originalText = saveNewEmailBtn.textContent;
                
                saveNewEmailBtn.textContent = 'Processing...';
                saveNewEmailBtn.disabled = true;

                if (!newEmail || !newEmail.includes('@') || !newEmail.includes('.')) {
                    alert("Please enter a valid new email address.");
                    saveNewEmailBtn.textContent = originalText;
                    saveNewEmailBtn.disabled = false;
                    return;
                }

                try {
                    const { error } = await supabase.auth.updateUser({ email: newEmail });

                    if (error) throw error;
                    
                    alert(`A confirmation email has been successfully sent to ${newEmail}. You will now be logged out. Please click the link in that email to complete the update and sign back in.`);
                    
                    await supabase.auth.signOut();
                    window.location.href = 'index.html';

                } catch (error) {
                    console.error('Error changing email:', error.message);
                    
                    let errorMessage = 'Failed to change email. This may be due to an expired session, network error, or the email already being in use.';

                    if (error.message.includes('Auth session missing!')) {
                        errorMessage = 'Your session has expired. Please log out, log back in, and try again.';
                    } else if (error.message.includes('User already exists')) {
                        errorMessage = 'This new email address is already associated with another account.';
                    }
                    
                    alert(errorMessage);
                    
                } finally {
                    if (window.location.href.includes('teacher-security.html')) {
                        document.getElementById('changeEmailForm').reset();
                        closeChangeEmailModal();
                        saveNewEmailBtn.textContent = originalText;
                        saveNewEmailBtn.disabled = false;
                    }
                }
            });
        }

        // --- Toggle Switch Logic (Data Consent) ---
        const toggleDataConsent = document.getElementById('toggleDataConsent');

        async function updateToggleState(columnName, isChecked, settingName) {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                     console.error("Session expired. Cannot update settings.");
                     alert("Your session has expired. Please log in again.");
                     return;
                }

                const { error } = await supabase
                    .from('profiles')
                    .update({ [columnName]: isChecked })
                    .eq('id', session.user.id)
                    .select(); 

                if (error) throw error;
                
                const status = isChecked ? 'Enabled' : 'Disabled';
                console.log(`${settingName} updated successfully. Status: ${status}`);

            } catch (error) {
                console.error(`Error updating ${settingName}:`, error);
                alert(`Failed to save ${settingName} setting. Please try again.`);
                if (document.getElementById(columnName)) {
                    document.getElementById(columnName).checked = !isChecked;
                }
            }
        }

        if (toggleDataConsent) {
            toggleDataConsent.addEventListener('change', () => {
                updateToggleState('data_consent', toggleDataConsent.checked, 'Data Usage Consent');
            });
        }


        // --- Global Close Modal Logic (Clicking outside) ---
        window.addEventListener('click', (event) => {
            if (event.target === changePasswordModal) {
                closeChangePasswordModal();
            }
            if (event.target === changeEmailModal) {
                closeChangeEmailModal();
            }
        });

        // --- Initialization ---
        async function initPage() {
            const navData = await initNavbar('profile');
            
            if (navData) {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('data_consent') 
                    .eq('id', navData.user.id)
                    .single();

                if (profile) {
                    if (toggleDataConsent) toggleDataConsent.checked = profile.data_consent !== false; 
                } else if (error && error.code !== 'PGRST116') { 
                     console.error('Error fetching initial settings:', error);
                }
            }
        }

        initPage();
    </script>
</body>
</html>